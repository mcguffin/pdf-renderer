!function(l,r,o){var n,d={view:{}},c=r.l10n;n=wp.media.View.extend({template:wp.template("pdf-page-item"),className:"pdf-page-item",initialize:function(){return wp.media.View.prototype.initialize.apply(this,arguments)},render:function(){return wp.media.View.prototype.render.apply(this,arguments)}}),d.view.PDFFrame=wp.media.view.MediaFrame.extend({template:wp.template("pdf-modal"),regions:["title","content","instructions","buttons","pagenav"],events:{"click [data-page]":"clickPage"},initialize:function(){return _.defaults(this.options,{uploader:!1,title:c.pdfUpload}),wp.media.view.MediaFrame.prototype.initialize.apply(this,arguments),this._pdf=this._canvas=null,this._current_page=0,this._pages={},this.createTitle(),this.createButtons(),this},createTitle:function(){this._title=new wp.media.View({tagName:"h1"}),this._title.$el.text(this.options.title),this.title.set([this._title])},createButtons:function(){var e=this;this.buttons.set([new wp.media.view.Button({text:c.CancelUpload,className:"cancel-upload",click:function(){e.trigger("cancel-upload"),e.close()}}),new wp.media.view.Button({text:c.UploadPDF,className:"upload-pdf",click:function(){}}),new wp.media.view.Button({text:c.UploadImages,className:"button-primary",click:function(){e.trigger("cancel-upload"),e.uploadImages(),e.close()}})])},setFile:function(e){var t=this,a=new FileReader;return this.file=e,a.onload=function(e){t.parsePDF(e.target.result)},a.readAsArrayBuffer(e.blob),this},clickPage:function(e){this.showPage(l(e.target).attr("data-page"))},renderPageNav:function(e){console.log();var t=this,a=1,i=[];for(this._pages={};a<=e;a++)this._pages[a]={page:!1,canvas:!1,selected:!0},i.push(new n({pagenum:a,selected:!0,events:{click:function(e){l(e.target).is(".dashicons")&&t.togglePage(this.options.pagenum),t.showPage(this.options.pagenum)}}}));this.pagenav.set(i)},parsePDF:function(e){var t=this;pdfjsLib.getDocument(e).then(function(e){t._pdf=e,t.renderPageNav(e.numPages),t.showPage(1)})},togglePage:function(e){this._pages[e].selected=!this._pages[e].selected,_.each(this._pages,function(e,t){console.log(t,e)})},showPage:function(e){var t=this;this._pages[e].canvas?this.content.set([new wp.media.View({el:this._pages[e].canvas})]):this.renderPage(e,function(){t.showPage(e)})},renderPage:function(n,o,s){var p=this;p._pdf.getPage(n).then(function(e){var t=e.getViewport(1),a=l("<canvas></canvas>").get(0),i=a.getContext("2d");t=e.getViewport(r.options.image_width/t.width),a.width=t.width,a.height=t.height,e.render({canvasContext:i,viewport:t}).then(function(){p._pages[n].page=e,p._pages[n].canvas=a,o&&o.apply(p._pages[n],s||[])})})},uploadImages:function(){var i=this,a="image/png",n=function(e){var t=new o.Image;t.onload=function(){t.name=e,t.type=a,i.options.uploader.addFile(t.getAsBlob(),e)},t.load(this.canvas.toDataURL(a)),l("body").append(t)};_.each(this._pages,function(e,t){var a=i.file.file.name.replace(/\.[a-z0-9]+$/,"")+"-p"+t+".png";e.canvas?n.apply(e):i.renderPage(1*t,n,[a])})}}),_.extend(wp.media.view.UploaderWindow.prototype,{_parentReady:wp.media.view.UploaderWindow.prototype.ready,didReady:!1,ready:function(){var s,p=[];if(this.didReady)return this._parentReady.apply(this,arguments);return this.didReady=!0,ret=this._parentReady.apply(this,arguments),this.uploader.uploader.bind("FilesAdded",function(e,t){for(var a,i,n,o=0;o<t.length;o++)"application/pdf"==t[o].type&&(i=t[o],n=void 0,(n={file:i,blob:i.getNative()}).blob||(n.blob=i.getSource()),(a=n).blob instanceof Blob&&p.push(a));p.length&&(e.stop(),e.refresh(),function e(t){var a;s&&s.close().dispose(),p.length?(a=p.shift(),(s=new d.view.PDFFrame({controller:l(this),uploader:t,title:c.Upload+": "+a.file.name.replace(/\.[a-z0-9]+$/,"")})).on("proceed",function(){e(t)}).on("cancel-upload",function(){a.file.attachment.destroy()}),s.setFile(a),s.open()):t.start()}(e))}),this.uploader.uploader.bind("BeforeUpload",function(e,t){}),ret}})}(jQuery,pdf_renderer,mOxie);